<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Kalkulator wypłat RealmRP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #374151; padding: 12px; text-align: left; white-space: nowrap; }
        th { 
            background-color: #312e81; 
            color: white; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            font-weight: bold; 
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        th:hover { background-color: #4338ca; }
        tr:nth-child(even) { background-color: #1f2937; }
        tr:hover { background-color: #374151; transition: 0.2s; }
        .scroll-custom::-webkit-scrollbar { width: 8px; height: 8px; }
        .scroll-custom::-webkit-scrollbar-track { background: #1f2937; }
        .scroll-custom::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .sort-asc::after { content: " ↑"; opacity: 0.7; }
        .sort-desc::after { content: " ↓"; opacity: 0.7; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-6 font-sans">

<div class="max-w-6xl mx-auto">
    <div class="bg-gray-800 shadow-2xl rounded-2xl p-8 border border-gray-700 mb-6">
        <h1 class="text-3xl font-bold text-indigo-400 mb-6 text-center">Kalkulator Zarobków RealmRP</h1>
        
        <div class="flex flex-col md:flex-row gap-4 items-center justify-center">
            <div class="w-full max-w-xs">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Wgraj plik z godzinami z tabletu (eksport)</label>
                <input id="fileInput" type="file" accept=".csv" 
                    class="block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-indigo-600 file:text-white hover:file:bg-indigo-500 cursor-pointer border border-gray-600 rounded-lg"/>
            </div>
            
            <div id="searchContainer" class="hidden w-full max-w-md">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Szukaj (SSN, Imię, Nazwisko):</label>
                <div class="relative">
                    <input id="searchInput" type="text" placeholder="Wpisz dane..." 
                        class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-indigo-500 outline-none transition-all pl-10">
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>
        </div>
    </div>

    <div id="ratesPanel" class="hidden bg-gray-800 rounded-2xl p-6 border border-indigo-500/50 mb-6 shadow-lg">
        <h2 class="text-xl font-bold text-indigo-300 mb-4 flex items-center gap-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            Ustal stawki godzinowe ($):
        </h2>
        <div id="ratesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </div>

    <div id="previewArea" class="hidden">
        <div class="overflow-x-auto bg-gray-800 rounded-xl border border-gray-700 shadow-xl max-h-[600px] overflow-y-auto scroll-custom">
            <table id="resultTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="mt-6 bg-indigo-900/40 border border-indigo-500 rounded-2xl p-6 flex justify-between items-center shadow-lg">
            <div class="flex flex-col">
                <span class="text-xs font-bold text-indigo-300 uppercase tracking-widest">Podsumowanie</span>
                <span class="text-xl font-semibold text-indigo-100 uppercase tracking-wider">Łączny koszt wypłat:</span>
            </div>
            <span id="totalDisplay" class="text-4xl font-black text-green-400 font-mono tracking-tighter">$0.00</span>
        </div>
    </div>
</div>

<script>
let csvData = [];
let headers = [];
let jobRates = {};
let sortConfig = { column: null, direction: 'asc' };
let searchQuery = "";

const miesiace = ["stycznia", "lutego", "marca", "kwietnia", "maja", "czerwca", "lipca", "sierpnia", "września", "października", "listopada", "grudnia"];

document.getElementById('fileInput').addEventListener('change', function(e) {
    const reader = new FileReader();
    reader.onload = function(event) {
        const lines = event.target.result.split(/\r?\n/).filter(l => l.trim() !== "");
        if (lines.length < 1) return;

        headers = parseCSVLine(lines[0]);
        csvData = lines.slice(1).map(line => {
            const row = parseCSVLine(line);
            return { raw: row, salary: 0 };
        });

        let jobColIndex = headers.findIndex(h => h.toLowerCase().includes("stanowisko"));
        if (jobColIndex === -1) jobColIndex = 3; 

        const uniqueJobs = new Set();
        csvData.forEach(item => {
            if (item.raw[jobColIndex]) uniqueJobs.add(item.raw[jobColIndex].trim());
        });

        const grid = document.getElementById("ratesGrid");
        grid.innerHTML = "";
      Array.from(uniqueJobs).sort().forEach(job => {
            if (!(job in jobRates)) jobRates[job] = 0;
            const div = document.createElement("div");
            div.className = "bg-gray-900/50 p-3 rounded-lg border border-gray-700 hover:border-indigo-500 transition-all";
            div.innerHTML = `
                <label class="block text-xs font-black text-indigo-400 uppercase mb-1">${job}</label>
                <div class="flex items-center gap-2">
                    <span class="text-green-500 font-bold">$</span>
                    <input type="number" 
                        step="100" 
                        value="${jobRates[job]}" 
                        oninput="updateRate('${job}', this.value)" 
                        onwheel="this.blur()"
                        class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-green-400 font-mono focus:ring-1 focus:ring-indigo-500 outline-none">
                    <span class="text-gray-500 text-sm">/h</span>
                </div>
            `;
            grid.appendChild(div);
        });

        document.getElementById("ratesPanel").classList.remove("hidden");
        document.getElementById("previewArea").classList.remove("hidden");
        document.getElementById("searchContainer").classList.remove("hidden");
        renderTable();
    };
    reader.readAsText(e.target.files[0]);
});

document.getElementById('searchInput').addEventListener('input', function(e) {
    searchQuery = e.target.value.toLowerCase();
    renderTable();
});

function updateRate(job, val) {
    jobRates[job] = parseFloat(val) || 0;
    renderTable();
}

function parseTimeToMinutes(timeStr) {
    if (!timeStr) return 0;
    let hours = 0, mins = 0;
    if (timeStr.includes('h')) {
        hours = parseInt(timeStr.match(/(\d+)h/) ? timeStr.match(/(\d+)h/)[1] : 0);
        mins = parseInt(timeStr.match(/(\d+)m/) ? timeStr.match(/(\d+)m/)[1] : 0);
    } else if (timeStr.includes(':')) {
        const p = timeStr.split(':');
        hours = parseInt(p[0]) || 0;
        mins = parseInt(p[1]) || 0;
    }
    return (hours * 60) + mins;
}

function calculateSalary(timeStr, rate) {
    const totalMinutes = parseTimeToMinutes(timeStr);
    return (totalMinutes / 60) * rate;
}

function formatDisplayValue(val) {
    let clean = val.replace(/^"|"$/g, '').trim();
    if (/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(clean)) {
        const części = clean.split('.');
        const dzien = parseInt(części[0]);
        const miesiacIdx = parseInt(części[1]) - 1;
        const rok = części[2];
        return `${dzien} ${miesiace[miesiacIdx]} ${rok}`;
    }
    if ((clean.includes('h') && clean.includes('m')) || /^\d{1,3}:\d{2}$/.test(clean)) {
        const totalMins = parseTimeToMinutes(clean);
        const h = Math.floor(totalMins / 60);
        const m = totalMins % 60;
        return `${h} godziny ${m} minut`;
    }
    return clean;
}

function sortTable(index) {
    if (sortConfig.column === index) {
        sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
    } else {
        sortConfig.column = index;
        sortConfig.direction = 'asc';
    }
    renderTable();
}

function renderTable() {
    const tableHead = document.getElementById("tableHead");
    const tableBody = document.getElementById("tableBody");
    const totalDisplay = document.getElementById("totalDisplay");

    let jobColIndex = headers.findIndex(h => h.toLowerCase().includes("stanowisko"));
    if (jobColIndex === -1) jobColIndex = 3;
    let timeColIndex = headers.findIndex(h => h.toLowerCase().includes("godziny"));
    if (timeColIndex === -1) timeColIndex = 4;

    let grandTotal = 0;
    csvData.forEach(item => {
        const rate = jobRates[item.raw[jobColIndex]?.trim()] || 0;
        item.salary = calculateSalary(item.raw[timeColIndex], rate);
        grandTotal += item.salary; 
    });

    let filteredData = csvData.filter(item => {
        return item.raw.some(cell => cell.toLowerCase().includes(searchQuery));
    });

    if (sortConfig.column !== null) {
        filteredData.sort((a, b) => {
            let valA, valB;
            if (sortConfig.column === headers.length) {
                valA = a.salary; valB = b.salary;
            } else {
                const rawA = a.raw[sortConfig.column];
                const rawB = b.raw[sortConfig.column];
                if (sortConfig.column === timeColIndex) {
                    valA = parseTimeToMinutes(rawA); valB = parseTimeToMinutes(rawB);
                } else if (/^\d{1,2}\.\d{1,2}\.\d{4}$/.test(rawA)) {
                    const pA = rawA.split('.'); const pB = rawB.split('.');
                    valA = new Date(pA[2], pA[1]-1, pA[0]).getTime();
                    valB = new Date(pB[2], pB[1]-1, pB[0]).getTime();
                } else if (!isNaN(rawA) && !isNaN(rawB) && rawA !== "" && rawB !== "") {
                    valA = parseFloat(rawA); valB = parseFloat(rawB);
                } else {
                    valA = rawA.toLowerCase(); valB = rawB.toLowerCase();
                }
            }
            if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
            if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
            return 0;
        });
    }

    tableHead.innerHTML = `<tr>${[...headers, "Wypłata"].map((h, i) => {
        let cls = i === sortConfig.column ? (sortConfig.direction === 'asc' ? 'sort-asc' : 'sort-desc') : '';
        return `<th class="${cls}" onclick="sortTable(${i})">${h}</th>`;
    }).join('')}</tr>`;

    tableBody.innerHTML = "";
    filteredData.forEach(item => {
        const tr = document.createElement("tr");
        item.raw.forEach(cell => {
            const td = document.createElement("td");
            td.innerText = formatDisplayValue(cell);
            tr.appendChild(td);
        });
        const tdSalary = document.createElement("td");
        tdSalary.className = "font-bold text-green-400 font-mono";
     
        tdSalary.innerText = "$" + item.salary.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        tr.appendChild(tdSalary);
        tableBody.appendChild(tr);
    });


    totalDisplay.innerText = "$" + grandTotal.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    if (searchQuery !== "") {
        totalDisplay.innerHTML += ` <span class="text-sm text-gray-400 block font-normal">(Suma wszystkich osób)</span>`;
    }
}

function parseCSVLine(text) {
    const result = [];
    let curVal = "", inQuotes = false;
    for (let i = 0; i < text.length; i++) {
        let char = text[i];
        if (char === '"') inQuotes = !inQuotes;
        else if (char === ',' && !inQuotes) { result.push(curVal.trim()); curVal = ""; }
        else curVal += char;
    }
    result.push(curVal.trim());
    return result;
}
</script>
</body>
</html>
